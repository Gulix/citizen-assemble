<html>
  <head>
    <script src="js/mustache.js"></script>
  
    <title>Citizen Assemble ! Pulp City Team Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen" />    
    <link rel="stylesheet" href="css/style.css" />
  </head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2">
        <form>
          <div class="form-group">
            <label for="selTeamAffiliation">Team Alignment / Faction</label>
            <select class="form-control" id="selTeamAffiliation"></select>
          </div>
        </form>
      </div>
      <div class="col-md-9 col-md-offset-1">
        <h1>Citizen Assemble !</h1>
        <h2>A team builder for <b>Pulp City</b></h2>
      </div>      
    </div>
    
    <!-- Filters -->
    <div class="row">
      
      <!-- Team Summary -->
	  <div class='col-md-2 team-summary'>
	    <dl class="dl-horizontal">
          <dt>Team Level</dt><dd id='team-summary-level'></dd>
		  <dt># of Supremes</dt><dd id='team-summary-number'></dd>
		  <dt>AP+</dt><dd id='team-summary-apgranted'></dd>
		  <dt>Minions+</dt><dd id='team-summary-minionsgranted'></dd>
        </dl>
		<div class='team-summary-exclusiveminions'></div>
		<div class="alert alert-info faction-card text-center" id="faction-card" role="alert">
		  <span class="glyphicon glyphicon-bookmark" aria-hidden="true"></span>
          Faction card granted !
		</div>
	  </div>
      
      <div class='col-md-10'>
        <!-- Factions -->
        <div class='col-md-2'>
          <label for="selFactions">Faction</label>
          <select id="selFactions" class="form-control" ></select>
        </div>
        <!-- Origins -->
        <div class='col-md-2'>
          <label for="selOrigins">Origin</label>
          <select id="selOrigins" class="form-control" ></select>
        </div>
        <!-- Roles -->
        <div class='col-md-2'>
          <label for="selRoles">Role</label>
          <select id="selRoles" class="form-control" ></select>
        </div>
        <!-- Levels -->
        <div class='col-md-2'>
          <label for="selLevels">Level</label>
          <select id="selLevels" class="form-control" >
            <option value='0'>Any</option>
            <option value='1'>Level 1</option>
            <option value='2'>Level 2</option>
            <option value='3'>Level 3</option>
            <option value='12'>Level 1 or 2</option>
            <option value='23'>Level 2 or 3</option>
          </select>
        </div>
        <!-- AP+ -->
        <div class='col-md-2'>
          <label for="selAPgranted">AP+</label>
          <select id="selAPgranted" class="form-control" >
            <option value='+0'>Any</option>
            <option value='+1'>1 or more</option>
            <option value='+2'>2 or more</option>
            <option value='+3'>3 or more</option>
            <option value='+4'>4 or more</option>
            <option value='=0'>0</option>
            <option value='=1'>1</option>
            <option value='=2'>2</option>
            <option value='=3'>3</option>
            <option value='=4'>4</option>
            <option value='-1'>1 or less</option>
            <option value='-2'>2 or less</option>
            <option value='-3'>3 or less</option>
            <option value='-4'>4 or less</option>
          </select>
        </div>
        <!-- Minions+ -->
        <div class='col-md-2'>
          <label for="selMinionsGranted">Minions+</label>
          <select id="selMinionsGranted" class="form-control" >
            <option value='+0'>Any</option>
            <option value='+1'>1 or more</option>
            <option value='+2'>2 or more</option>
            <option value='+3'>3 or more</option>
            <option value='+4'>4 or more</option>
            <option value='=0'>0</option>
            <option value='=1'>1</option>
            <option value='=2'>2</option>
            <option value='=3'>3</option>
            <option value='=4'>4</option>
            <option value='-1'>1 or less</option>
            <option value='-2'>2 or less</option>
            <option value='-3'>3 or less</option>
          </select>
        </div>
        <!-- Text filter -->
        <div class='col-md-4'>
          <label for="txtFilterName">Supreme name</label>
          <input id='txtFilterName' type="text" class="form-control" placeholder="Search for..."></input>          
        </div>
      </div>
    </div>
    
    <div class="row">
      <!-- Selected items -->
      <div class="col-md-2">        
        <div class="alert alert-warning honorary-member text-center" id="honorary-member" role="alert">
		  <span class="glyphicon glyphicon-star" aria-hidden="true"></span>
          Honorary Member
		</div>
        
        <!--<div id="divHonoraryMember">
        <input id="togHonoraryMember"
               data-toggle="toggle" data-onstyle="warning" data-offstyle="default"
               data-on="Honorary<br />Member" data-off="Normal<br/>Members" type="checkbox" >
        </div>-->
		
        <div class="supremes-selected-list" id="list-selected">        
        </div>
      </div>
      <!-- List of items -->
      <div class="col-md-10 supremes-list" id="list-supremes">
      </div>
    </div>
    
    <div id="list-modal-supremes">
    </div>
    
    <div class="modal fade" id="modal-get-code" tabindex="-1" role="dialog" aria-labelledby="modal-get-code-label">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="modal-get-code-label">Get Team unique code</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="lbl-current-team-code">Unique code for your Team</label>
              <input type="text" class="form-control" id="lbl-current-team-code" readonly>
            </div>
            <div class="form-group">
              <label for="lbl-current-team-code-url">URL for your Team</label>
              <input type="text" class="form-control" id="lbl-current-team-code-url" readonly>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="modal-enter-code" tabindex="-1" role="dialog" aria-labelledby="modal-enter-code-label">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="modal-enter-code-label">Enter a Team unique code</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="lbl-enter-team-code">Unique code for your Team</label>
              <input type="text" class="form-control" id="lbl-enter-team-code" >
            </div>
            <div class="bg-danger" id="enter-code-error">Message</div>
            <div class="bg-warning" id="enter-code-warning">Message</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id='btn-validate-code'>Enter code</button>            
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
</div>
  </div>
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
</body>
<script>

window.supremes_list = [];
window.selected_supremes_list = [];

var supremesFilled = false;
var supremesSelectionFilled = false;
var supremesModalFilled = false;
var factionsFilled = false;

/********************/
/*** The Supremes ***/
/********************/
function fill_supremes()
{
  $.getJSON("json/supremes.json", function(json) {
    
    // Sort by Name
    json.sort(function(a, b)
    {
      if (a.name < b.name) return -1;
      if (b.name < a.name) return 1;
      return 0;
    });
    window.supremes_list = json;
    window.selected_supremes_list = [];
    
    // Fill some fields (key to value)
	update_role();
    
    // View to render via Mustache
    var view = { "supremes": window.supremes_list };
    
    // The main list
    $.ajax(
    {
      url: "mustache/supremes.mst",
      success: function( mustacheTemplate ) 
        {
          var renderedHtml = Mustache.render(mustacheTemplate, view);
          $("#list-supremes").html(renderedHtml);
          fill_factions_name();
		  fill_freelancer();
          filter_supremes();
          $(".btn-select-supreme").click(function() { select_supreme(getSupremeId("btn-select-supreme-", $(this).attr('id'))); });
          supremesFilled = true;
          load_code_from_url();
        },
      dataType: "text"
    });
    
    // The Supremes rendered on a modal view
    $.ajax(
    {
      url: "mustache/supremes_modal.mst",
      success: function( mustacheTemplate ) 
        {
          var renderedHtml = Mustache.render(mustacheTemplate, view);
          $("#list-modal-supremes").html(renderedHtml);
          fill_freelancer();
          setPopupsElements();
          // Clear the Description div if it has no child
          $(".supreme-description").each(function() { if($(this).children().length == 0) { $(this).hide(); } });
          // Events on Buttons
          $(".btn-select-supreme-modal").click(function() { select_supreme(getSupremeId("btn-select-supreme-modal-", $(this).attr('id'))); });
          $(".btn-unselect-supreme-modal").click(function() { unselect_supreme(getSupremeId("btn-unselect-supreme-modal-", $(this).attr('id')), true); });
          $(".btn-unselect-supreme-modal").hide();
          supremesSelectionFilled = true;
          load_code_from_url();
        },
      dataType: "text"
    });
    
    // The "Selected Supremes" list
    $.ajax(
    {
      url: "mustache/supremes_selection.mst",
      success: function( mustacheTemplate ) 
        {
          // Render the Supremes with a Mustache template
          var renderedHtml = Mustache.render(mustacheTemplate, view);
          $("#list-selected").html(renderedHtml);
          // Hiding the elements
          $(".supreme-selection").each(function() { $( this ).hide(); });
          // Click on Buttons
          $(".btn-unselect-supreme").click(function() { unselect_supreme(getSupremeId("btn-unselect-supreme-", $(this).attr('id')), true); });
		  $('#btnHideSelectionFooter').click(function() { hide_selection_footer(); });
          $('#btnShowSelectionFooter').click(function() { show_selection_footer(); });
		  $(".supreme-selection > .header").click(function() 
          { 
            toggle_selection_footer(getSupremeId("supreme-selection-", $(this).parent().attr('id'))); 
          });
          supremesModalFilled = true;
          load_code_from_url();
        },
      dataType: "text"
    });
  });  
}

function get_json_supreme(id)
{
  for(var i=0; i<window.supremes_list.length; i++)
    if (window.supremes_list[i].id == id) return window.supremes_list[i];
    
  return null;
}

function fill_factions_name()
{
  $.getJSON("json/factions.json", function(jsonFactions) {
    
	$('.supreme-factions').each(function () {      
	  var supremeFactions = $(this).html();
      if ((supremeFactions === undefined) || (supremeFactions.length == 0))
        $(this).html('<span class="faction-independant">Independant</span>');
      else 
      {
        var splitFactions = supremeFactions.split(',');
        var newHtml = '';
        var separator = '';
        for(var iSupFac = 0; iSupFac < splitFactions.length; iSupFac++)
        {
		  var faction;
		  for (var iFaction = 0; iFaction <= jsonFactions.length; iFaction++)
		  {
		    if (jsonFactions[iFaction]["faction_key"] == splitFactions[iSupFac])
			{
			  faction = jsonFactions[iFaction]["faction_label"];
			  break;
			}
		  }
		  if (faction !== undefined)
		  {
            newHtml = newHtml + separator +
              '<span class="faction-' + splitFactions[iSupFac] + '">' + faction + '</span>';
            separator = ', ';
	      }
        }
		$(this).html(newHtml);
      }
    });
  }); 
}

function fill_freelancer()
{
  $('.supreme-freelance-0').remove();
  $('.supreme-freelance-1').replaceWith("<img class='supreme-freelance' title='Freelancer' src='img/freelancer.png' />");
}

/*************************/
/*** Selected Supremes ***/
/*************************/
function select_supreme(id)
{
  $("#supreme-selection-" + id).show();
  // Buttons in the modal view
  $("#btn-select-supreme-modal-" + id).hide();
  $("#btn-unselect-supreme-modal-" + id).show();
  var supremeSelected = get_json_supreme(id);
  
  // Is 'Honorary Member' selected ?
  if (isSelectedAsHonoraryMember(supremeSelected))
  {
    supremeSelected.is_honorary_member = true;
    $("#supreme-selection-" + id + " .supreme-name").html('<span class="glyphicon glyphicon-star icon-honorary-member" aria-hidden="true" title="Honorary Member" />' + supremeSelected.name);
  }
  else 
  {
    supremeSelected.is_honorary_member = false;
    $("#supreme-selection-" + id + " .icon-honorary-member").remove();
  }
  
  window.selected_supremes_list.push(supremeSelected);
    
  sort_selected_supremes();
  update_summary();
  check_honorary_member();
  set_unique_code();
  check_faction_cards();
  filter_supremes();
}

function unselect_supreme(id, refreshAll)
{
  $("#supreme-selection-" + id).hide();
  $("#supreme-selection-" + id).removeAttr("data-sort");
  // Buttons in the modal view
  $("#btn-select-supreme-modal-" + id).show();
  $("#btn-unselect-supreme-modal-" + id).hide();
  for(var i=0; i<window.selected_supremes_list.length; i++)
  {
    if (window.selected_supremes_list[i].id == id)
    {
      // If this is a Leader, all the Honorary Members are also removed
      var isLeader = window.selected_supremes_list[i].role_key == 'leader';
      window.selected_supremes_list.splice(i, 1);
      break;
    }
  }
  // Removing the Honorary Member
  if (isLeader)
  {
    for(var i=0; i<window.selected_supremes_list.length; i++)
    {
      if (window.selected_supremes_list[i].is_honorary_member)
      {
        unselect_supreme(window.selected_supremes_list[i].id, false);
      }
    }
  }
  
  if (refreshAll)
  {
    sort_selected_supremes();
    check_honorary_member();
    filter_supremes();
    update_summary();
    set_unique_code();
	check_faction_cards();
  }
}

function clear_selection()
{
  $('.supreme-selection').hide();
  window.selected_supremes_list.splice(0, window.selected_supremes_list.length);
  filter_supremes();
  update_summary();
}

function sort_selected_supremes()
{
  // Apply sort index
  $(".supreme-selection:hidden").attr("data-sort", window.selected_supremes_list.length + 1);
  for (var iSup = 0; iSup < window.selected_supremes_list.length; iSup++)
  {
    $("#supreme-selection-" + window.selected_supremes_list[iSup].id).attr("data-sort", iSup);
  }
  
  var $supreme_list = $('#list-selected');
  var $supremes = $supreme_list.children();

  $supremes.sort(function(a,b){
    var aSort = a.getAttribute('data-sort');
    var bSort = b.getAttribute('data-sort');
    
    if (aSort === undefined) aSort = window.selected_supremes_list.length + 1;
    if (bSort === undefined) bSort = window.selected_supremes_list.length + 1;
  
    if (aSort > bSort)
      return 1;
  if (aSort < bSort)
      return -1;
  return 0;
  });

  $supremes.detach().appendTo($supreme_list);
}

function hide_selection_footer()
{
  $('.supreme-selected-list-element .supreme-role').slideUp(300);
  $('.supreme-selected-list-element .bottom-footer').slideUp(300);
}

function show_selection_footer()
{
  $('.supreme-selected-list-element .supreme-role').slideDown(300);
  $('.supreme-selected-list-element .bottom-footer').slideDown(300);
}

function toggle_selection_footer(id)
{
  $('#supreme-selection-' + id +' .supreme-role').slideToggle(300);
  $('#supreme-selection-' + id +' .bottom-footer').slideToggle(300);
}

/********************/
/*** Faction card ***/
/********************/
function load_faction_cards()
{
  $.getJSON("json/factions-cards.json", function(jsonCards) {
    window.faction_cards = jsonCards;
	check_faction_cards();
  });
}

function check_faction_cards()
{
  if ((window.faction_cards === undefined) || (window.faction_cards === null))
  {
    load_faction_cards();
	return;
  }

  // Checking if any of the cards comply with the Team selection
  var cardGranted = null;
  for(var iCard = 0; iCard < window.faction_cards.length; iCard++)
  {
    // Is the required leader present in the team ?
	var leaderFound = false;
	for (var iLeader = 0; iLeader < window.selected_supremes_list.length; iLeader++)
	{
	  leaderFound = isInTable(window.faction_cards[iCard].leaders_required, window.selected_supremes_list[iLeader].id);
	  if (leaderFound) break;
	}
	if (!leaderFound) continue;
	
	// Condition on the faction of the Supremes
	if (window.faction_cards[iCard].faction_required !== null)
	{
	  var factionOK = true;
	  for(var iSup = 0; iSup < window.selected_supremes_list.length; iSup++)
	  {
	    if(!isInTable(window.selected_supremes_list[iSup].factions, window.faction_cards[iCard].faction_required) 
		   && ((window.selected_supremes_list[iSup].is_honorary_member !== undefined) && !window.selected_supremes_list[iSup].is_honorary_member))
		{
		  factionOK = false;
		  break;
		}
	  }
	  if (factionOK)
	  {
	    cardGranted = window.faction_cards[iCard];
		break;
	  }
	}
	
	// Condition on the Origin of the Supremes
	if (window.faction_cards[iCard].origin_required !== null)
	{
	  var originOK = true;
	  for(var iSup = 0; iSup < window.selected_supremes_list.length; iSup++)
	  {
	    if(window.selected_supremes_list[iSup].origin != window.faction_cards[iCard].origin_required)
		{
		  originOK = false;
		  break;
		}
	  }
	  if (originOK)
	  {
	    cardGranted = window.faction_cards[iCard];
		break;
	  }
	}
	
	// Condition on the Alignment of the Supremes
	if (window.faction_cards[iCard].alignment_required !== null)
	{
	  var isHeroRequired = window.faction_cards[iCard].alignment_required == "hero";
	  var isVillainRequired = window.faction_cards[iCard].alignment_required == "villain";
	  var alignmentOK = true;
	  for(var iSup = 0; iSup < window.selected_supremes_list.length; iSup++)
	  {
	    // Supremes must not be in any Faction (or be a Freelancer or an Honorary Member)
	    if((!window.selected_supremes_list[iSup].is_hero && isHeroRequired)
		   || (!window.selected_supremes_list[iSup].is_villain && isVillainRequired)
		   || ((window.selected_supremes_list[iSup].factions.length > 0) 
		       && !window.selected_supremes_list[iSup].is_freelance
               && !window.selected_supremes_list[iSup].is_honorary_member))
		{
		  alignmentOK = false;
		  break;
		}
	  }
	  if (alignmentOK)
	  {
	    cardGranted = window.faction_cards[iCard];
		break;
	  }
	}
  }
  
  if (cardGranted !== null)
  {
    $('#faction-card').show();
  }
  else 
  {
    $('#faction-card').hide();
  }
}

/************************/
/*** Team Unique Code ***/
/************************/
function load_code_from_url()
{
  if (!supremesFilled || !supremesSelectionFilled || !supremesModalFilled || !factionsFilled)
    return;

  var codeFromUrl = get('code');
  if (codeFromUrl !== undefined)
  {
    enter_unique_code(codeFromUrl);
  }
}

function set_unique_code()
{
  $.getJSON("json/factions.json", function(jsonFactions) {
    var uniqueCode = '';
    // First 2 chars : Team affiliation
    var aff = $('#selTeamAffiliation').val();
    if (aff == 'a_heroes')
      uniqueCode = 'HE';
    else if (aff == 'a_villains')
      uniqueCode = 'VI';
    else 
    {
      for(var iFaction = 0; iFaction < jsonFactions.length; iFaction++)
      {
        if (aff == "f_" + jsonFactions[iFaction].faction_key)
        {
          uniqueCode = jsonFactions[iFaction].id;
          break;
        }
      }
    }
    // Next char : max number of character to id a supreme
    var idNbCharMax = 0;
    for (var iSup = 0; iSup < window.selected_supremes_list.length; iSup++)
    {
      idNbCharMax = Math.max(idNbCharMax, window.selected_supremes_list[iSup].id.toString().length);
    }
    uniqueCode = uniqueCode + idNbCharMax;
    
    // List of Supremes'ID
    for (var iSup = 0; iSup < window.selected_supremes_list.length; iSup++)
    {
      uniqueCode += pad(window.selected_supremes_list[iSup].id, idNbCharMax);
    }    
    
    $('#lbl-current-team-code').val(uniqueCode);
    $('#lbl-current-team-code-url').val(location.protocol + '//' + location.host + location.pathname + "?code=" + uniqueCode);
  });
}

function enter_unique_code(teamCode)
{
  $.getJSON("json/factions.json", function(jsonFactions) {
    clear_selection();
    
    $('#enter-code-error').hide();
    $('#enter-code-warning').hide();
    
    // First 2 chars : Team affiliation
    var teamAffiliation = teamCode.substring(0, 2);
    var teamAffCode = '';
    if (teamAffiliation == 'HE')
      teamAffCode = 'a_heroes';
    else if (teamAffiliation == 'VI')
      teamAffCode = 'a_villains';
    else 
    {
      for(var iFaction = 0; iFaction < jsonFactions.length; iFaction++)
      {
        if (teamAffiliation == jsonFactions[iFaction].id.toString())
        {
          teamAffCode = 'f_' + jsonFactions[iFaction].faction_key;
          break;
        }
      }
    }
    if (teamAffCode == '')
    {  
        error_code("No faction or Alignment matches this code."); 
        return;    
    }
    $('#selTeamAffiliation').val(teamAffCode);
    changeAffiliation();
    
    // Next char : max number of character to id a supreme
    var idNbCharMax = Number(teamCode.substring(2, 3));
    if (isNaN(idNbCharMax) || (idNbCharMax <= 0)) 
    { 
      error_code("Incorrect value for the code."); 
      return; 
    }
       
    for(var iChar = 3; iChar < teamCode.length; iChar += idNbCharMax)
    {
      var supremeId = Number(teamCode.substring(iChar, iChar + idNbCharMax));
      if (isNaN(supremeId)) 
      { 
        warning_code("Part of the code has been ignored because it doesn't match a Supreme code."); 
        return;
      }
      select_supreme(supremeId);
    }
  });
}

function error_code(errorMessage)
{
  $('#enter-code-error').html(errorMessage);
  $('#enter-code-error').show();
}

function warning_code(errorMessage)
{
  $('#enter-code-warning').html(errorMessage);
  $('#enter-code-warning').show();
}

/*****************/
/*** The Roles ***/
/*****************/
// Fill the "Roles" combo box
function fill_roles()
{
  $.getJSON("json/roles.json", function(json) {
    
    window.supremes_roles = json;
    for(var i = 0; i < window.supremes_roles.length; i++)
    {
       $('#selRoles').append('<option value="' + window.supremes_roles[i].role_key + '">' + window.supremes_roles[i].role_label + '</option>');
    }
	update_role();
  });  
}

function get_role_value(role_key)
{
  for(var i = 0; i < window.supremes_roles.length; i++)
  {
    if (role_key == window.supremes_roles[i].role_key)
      return window.supremes_roles[i].role_label;    
  }
  
  return "???";
}

function update_role()
{
  if (window.supremes_roles === undefined) return;
  if (window.supremes_list === undefined) return;
    
  for(var i = 0; i < window.supremes_list.length; i++)
  {
    window.supremes_list[i].role = get_role_value(window.supremes_list[i].role_key);
  }
}

/*******************/
/*** The Origins ***/
/*******************/
function fill_origins()
{
  $.getJSON("json/origins.json", function(json) {
    
    for(var i = 0; i < json.length; i++)
    {
       $('#selOrigins').append('<option value="' + json[i].origin_key + '">' + json[i].origin_label + '</option>');
    }
  });  
}

/********************/
/*** The Factions ***/
/********************/
function fill_factions()
{
  $.getJSON("json/factions.json", function(json) {
    // Sort factions by name
    json.sort(function(a, b)
    {
      if (a.faction_key < b.faction_key) return -1;
      if (b.faction_key < a.faction_key) return 1;
      return 0;
    });
    
    var ignoredFactions = [ "-0", "-1", "-2" ];
    $('#selTeamAffiliation').append('<optgroup label="Factions" id="optgTeamAffiliationFaction"></optgroup>');
    for(var i = 0; i < json.length; i++)
    {
      // Add the factions in the Affiliation combo box
      if (!isInTable(ignoredFactions, json[i].faction_key))
        $('#optgTeamAffiliationFaction').append('<option value="f_' + json[i].faction_key + '">' + json[i].faction_label + '</option>');
      // Add the factions in the Factions combo box
      $('#selFactions').append('<option value="' + json[i].faction_key + '">' + json[i].faction_label + '</option>');
    }
    
    $('#selFactions').val("-0");
    
    factionsFilled = true;
    load_code_from_url();
  });
}

function get_selectedLeader_faction()
{
  for (var iSup = 0; iSup < window.selected_supremes_list.length; iSup++)
  {
    if (window.selected_supremes_list[iSup].role_key == "leader")
      return window.selected_supremes_list[iSup].factions;
  }
  
  return null;
}

/******************/
/*** Alignments ***/
/******************/
function fillAlignments()
{
  $('#selTeamAffiliation').append('<optgroup label="Alignments">'
                                   + '<option value="a_heroes">Heroes</option>'
                                   + '<option value="a_villains">Villains</option>'
                                 + '</optgroup>');
}

/************************/
/*** Team Affiliation ***/
/************************/
function changeAffiliation()
{
  var affiliation = $('#selTeamAffiliation').val();
  if (affiliation === null) return;
  var isAlignment = (affiliation.indexOf('a_') === 0);
  var isFaction = (affiliation.indexOf('f_') === 0);
  
  if (isFaction)
  {
    // The faction filter is set and disabled to the selected Faction in the Affiliation
    var keyFaction = affiliation.substring(2);
    $('#selFactions').val(keyFaction);
    $('#selFactions').prop('disabled', 'disabled');
  }
  else if (isAlignment)
  {
    $('#selFactions').prop('disabled', false);
  }
  
  filter_supremes();
}

function getSupremeId(strStartId, strId)
{
  if (strId === undefined)
    return 0;
  return strId.substring(strStartId.length);
}

function confirmAffiliationChange()
{
  var countSelectedSupremes = $('.supreme-selection:visible').length;
  if (countSelectedSupremes > 0)
  {
    if (!confirm('Are you sure you want to change your Team Affiliation ?\nYour team composition will be cleared.')) 
    {
      var current = $.data(this, 'current');
      if ((current === null) || (current === undefined))
        current = "a_heroes";
      $(this).val(current); // added parenthesis (edit)
      return false;
    }
  }
  
  $.data(this, 'current', $(this).val());
  clear_selection();
  check_honorary_member();
  changeAffiliation();
  check_faction_cards();
}

/*********************/
/*** Honorary Member */
/*********************/
function check_honorary_member()
{
  var displayed = false;
  var disabled = false;
  var active = $('#honorary-member').hasClass('honorary-member-active');
  for (var iSel = 0; iSel < window.selected_supremes_list.length; iSel++)
  {
    if (window.selected_supremes_list[iSel].role_key == "leader")
      displayed = true;
    if (window.selected_supremes_list[iSel].is_honorary_member)
      disabled = true;
  }
  
  // Toggle button is displayed if there is a Leader in the selected list
  if (displayed)
    $('#honorary-member').show();
  else 
    $('#honorary-member').hide();
  
  // If there is already an Honorary Member, click is not enabled, the star is empty, the color changes
  $('#honorary-member').removeClass('honorary-member-activable honorary-member-active honorary-member-disabled');
    
  if (disabled)
    $('#honorary-member').addClass('honorary-member-disabled');
  else if (displayed && active)
    $('#honorary-member').addClass('honorary-member-active');
  else 
    $('#honorary-member').addClass('honorary-member-activable');
}

function isSelectedAsHonoraryMember(supremeSelected)
{
  if (!$('#honorary-member').hasClass('honorary-member-active'))
    return;
  
  // Leader factions
  var leaderFactions = get_selectedLeader_faction();
  if (leaderFactions === null)
    return false;
      
  // Leader with no factions, Supreme with no faction or Freelancer : Not an Honorary Member
  if ((leaderFactions.length == 0) && ((supremeSelected.factions.length == 0) || supremeSelected.is_freelance))
    return false;
  // Faction of the leader is found within the Supreme Factions : Not an Honorary Member
  var factionFound = false;
  for (var iFaction = 0; iFaction < leaderFactions.length; iFaction++)
  {
    if (isInTable(supremeSelected.factions, leaderFactions[iFaction]))
      factionFound = true;
  }
  if (factionFound)
    return false;
    
  // The Supreme is an Honorary Member
  return true;
}

function change_honorary_member()
{
  // Nothing to do when disabled
  if ($('#honorary-member').hasClass('honorary-member-disabled'))
    return;
    
  if ($('#honorary-member').hasClass('honorary-member-activable'))
  {
    $('#honorary-member').removeClass('honorary-member-activable');
    $('#honorary-member').addClass('honorary-member-active');
    filter_supremes();
  }
  else if ($('#honorary-member').hasClass('honorary-member-active'))
  {
    $('#honorary-member').removeClass('honorary-member-active');
    $('#honorary-member').addClass('honorary-member-activable');
    filter_supremes();
  }
}

/************************************/
/*** Elements and info in Pop-Ups ***/
/************************************/
function setPopupsElements()
{
    var popupOptions = { trigger: "hover", placement: "top", html: true };
    // Element air    
    popupOptions['title'] = "Air element";
    popupOptions['content'] = "Strong/<b>Water</b> & Strong/<b>Flight</b><br /><i>Earth is Strong/Air</i>";
    $('.icon-element-air').popover(popupOptions);
    // Element water
    popupOptions['title'] = "Water element";
    popupOptions['content'] = "Strong/<b>Fire</b> & Strong/<b>Mechanical</b><br /><i>Air is Strong/Water</i>";
    $('.icon-element-water').popover(popupOptions);
    // Element fire
    popupOptions['title'] = "Fire element";
    popupOptions['content'] = "Strong/<b>Earth</b> & Strong/<b>Non-living</b><br /><i>Water is Strong/Fire</i>";
    $('.icon-element-fire').popover(popupOptions);
    // Element earth
    popupOptions['title'] = "Earth element";
    popupOptions['content'] = "Strong/<b>Air</b> & Strong/<b>Objects and Structures</b><br /><i>Fire is Strong/Earth</i>";
    $('.icon-element-earth').popover(popupOptions);
    // Element light
    popupOptions['title'] = "Light element";
    popupOptions['content'] = "Strong/<b>Darkness</b> & Strong/<b>Outsider</b><br /><i>Darkness is Strong/Light</i>";
    $('.icon-element-light').popover(popupOptions);
    // Element darkness
    popupOptions['title'] = "Darkness element";
    popupOptions['content'] = "Strong/<b>Light</b> & Strong/<b>Living</b><br /><i>Light is Strong/Darkness</i>";
    $('.icon-element-darkness').popover(popupOptions);
}

/**************/
/*** Filter ***/
/**************/
function filter_supremes()
{
   
  // Role filter
  var roleFilter = $('#selRoles').val();
  if (roleFilter === null)
    roleFilter = "0";
  // Origin filter
  var originFilter = $('#selOrigins').val();
  if (originFilter === null)
    originFilter = "0";
  // Faction filter
  var factionFilter = $('#selFactions').val();
  if (factionFilter === null)
    factionFilter = "-0"; 
  var isFactionSelected = !isInTable(["-0", "-1", "-2"], factionFilter);
  var isFactionWithout = (factionFilter == "-1");
  var isFactionWithoutWithFreelance = (factionFilter == "-2");
  // Levels
  var levelsAccepted = [ ];
  var levelFilter = $("#selLevels").val();
  if (levelFilter === null)
    levelFilter = "0";
  if ((levelFilter == "0") || levelFilter.indexOf("1") > -1)
    levelsAccepted.push(1);
  if ((levelFilter == "0") || levelFilter.indexOf("2") > -1)
    levelsAccepted.push(2);
  if ((levelFilter == "0") || levelFilter.indexOf("3") > -1)
    levelsAccepted.push(3);
  // AP+
  var apFilter = $("#selAPgranted").val();
  if (apFilter === null)
    apFilter = "+0";
  var apValue = Number(apFilter.substring(1));
  if (isNaN(apValue)) apValue = 0;
  var apgrantedAccepted = [ ];
  if (apFilter.indexOf("+") == 0)
    for(var i = apValue; i <= 6; i++) { apgrantedAccepted.push(i); }
  else if (apFilter.indexOf("-") == 0)
    for(var i = apValue; i >= 0; i--) { apgrantedAccepted.push(i); }
  else if (apFilter.indexOf("=") == 0)
    apgrantedAccepted.push(apValue);    
  // Minions+
  var minionsFilter = $("#selMinionsGranted").val();
  if (minionsFilter === null)
    minionsFilter = "+0";
  var minionsValue = Number(minionsFilter.substring(1));
  if (isNaN(minionsValue)) minionsValue = 0;
  var minionsGrantedAccepted = [ ];
  if (minionsFilter.indexOf("+") == 0)
    for(var i = minionsValue; i <= 6; i++) { minionsGrantedAccepted.push(i); }
  else if (minionsFilter.indexOf("-") == 0)
    for(var i = minionsValue; i >= 0; i--) { minionsGrantedAccepted.push(i); }
  else if (minionsFilter.indexOf("=") == 0)
    minionsGrantedAccepted.push(minionsValue);    
  // Filter on name
  var filterName = $('#txtFilterName').val();
  if (filterName === null)
    filterName = '';
  filterName = filterName.trim().toUpperCase();
   
  // Heroes / Villains
  var alignment = $('#selTeamAffiliation').val();
  var isHeroesOnly = (alignment == 'a_heroes');
  var isVillainsOnly = (alignment == 'a_villains');
  var isAlignementFaction = alignment.substring(0, 2) == "f_";
  
  // Honorary Member active ?
  var isHonoraryMember = $('#honorary-member').hasClass('honorary-member-active');
  if (isHonoraryMember && isFactionSelected)
  {
    isFactionSelected = false; // Honorary Member means we can select from any faction
  }
    
  var excludeLeader = false; // Only one Leader
  var excludePowerhouse = false; // Only one Powerhouse
  var excludedSupremesId = []; // List of excluded Supremes
  var shownSupremesId = []; // Special shown Supremes
  for (var iSel=0; iSel < window.selected_supremes_list.length; iSel++)
  {
    if (window.selected_supremes_list[iSel].role_key == "leader")
      excludeLeader = true;
    if (window.selected_supremes_list[iSel].role_key == "powerhouse")
      excludePowerhouse = true;
     
    // Excluded supremes
    if (window.selected_supremes_list[iSel].excluded_supremes)
    {
      for (var iExcl = 0; iExcl < window.selected_supremes_list[iSel].excluded_supremes.length; iExcl++)
        excludedSupremesId.push(window.selected_supremes_list[iSel].excluded_supremes[iExcl]);
    }
    
    // Shown supremes only when another is selected
    if (window.selected_supremes_list[iSel].shown_supremes)
    {
      for (var iShwn = 0; iShwn < window.selected_supremes_list[iSel].shown_supremes.length; iShwn++)
        shownSupremesId.push(window.selected_supremes_list[iSel].shown_supremes[iShwn]);
    }
  }  
   
  for(var i=0; i < window.supremes_list.length; i++)
  {
    var isSelected = $('#supreme-selection-' + window.supremes_list[i].id).is(':visible');
  
    if (
     (window.supremes_list[i].supreme_is_hidden && !isInTable(shownSupremesId, window.supremes_list[i].id)) // Special shown Supremes
     || ((roleFilter != "0") && (window.supremes_list[i].role_key != roleFilter)) // Role
     || ((originFilter != "0") && (window.supremes_list[i].origin != originFilter)) // Origin
     // Factions
     || (isFactionSelected && !isInTable(window.supremes_list[i].factions, factionFilter))
     || (isFactionWithout && !(window.supremes_list[i].factions.length == 0))
     || (isFactionWithoutWithFreelance && !(window.supremes_list[i].factions.length == 0) && !window.supremes_list[i].is_freelance)
     // Exclusive factions (Supreme only available in some factions, such as #2 & #3 of Troopers)
     || ((window.supremes_list[i].exclusive_factions !== undefined)
         && (!isAlignementFaction || !isInTable(window.supremes_list[i].exclusive_factions, factionFilter)))
     // Level
     || ($.inArray(window.supremes_list[i].level, levelsAccepted) == -1)
     // AP+
     || ((window.supremes_list[i].role_key == "powerhouse") && (apgrantedAccepted.indexOf(0) < 0))
     || ((window.supremes_list[i].role_key != "powerhouse") && (apgrantedAccepted.indexOf(window.supremes_list[i].ap_granted) < 0))
     // Minions+
     || (minionsGrantedAccepted.indexOf(window.supremes_list[i].minions_granted) < 0)
     // Filter on name
     || ((filterName != '') && (window.supremes_list[i].name.toUpperCase().indexOf(filterName) < 0))
     // Hero
     || (isHeroesOnly && !window.supremes_list[i].is_hero) 
     // Villain
     || (isVillainsOnly && !window.supremes_list[i].is_villain) 
     || isSelected
     // Only one Leader / Powerhouse
     || (excludeLeader && (window.supremes_list[i].role_key == "leader"))
     || (excludePowerhouse && (window.supremes_list[i].role_key == "powerhouse"))
     // Excluded supremes
     || (isInTable(excludedSupremesId, window.supremes_list[i].id))
     // Excluded factions
     || (isAlignementFaction && window.supremes_list[i].excluded_factions && isInTable(window.supremes_list[i].excluded_factions, factionFilter))
    )
    {
      $('#supreme-list-' + window.supremes_list[i].id).hide();
    }
    else
    {
      $('#supreme-list-' + window.supremes_list[i].id).show();
    }
  }
}

/***************/
/*** Summary ***/
/***************/
function update_summary()
{
  var teamLevel = 0;
  var teamNumber = 0;
  var teamAP = 0;
  var teamMinions = 0;
  var exclusiveMinions = [ ];
  for(var i=0; i<window.supremes_list.length; i++)
  {
    if ($("#supreme-selection-" + window.supremes_list[i].id).is(':visible') == true)
    {
      teamLevel += window.supremes_list[i].level;
      teamNumber += 1;
      if (window.supremes_list[i].role_key != "powerhouse")
        teamAP += window.supremes_list[i].ap_granted;
      teamMinions += window.supremes_list[i].minions_granted;
	  if (window.supremes_list[i].exclusive_minions.length > 0)
      {
        exclusiveMinions.push(window.supremes_list[i].exclusive_minions);
      }	  
    }
  }
    
  $("#team-summary-level").html(teamLevel);
  $("#team-summary-number").html(teamNumber);
  $("#team-summary-apgranted").html(teamAP);
  $("#team-summary-minionsgranted").html(teamMinions);
  if (exclusiveMinions.length == 0) 
  {
    $(".team-summary-exclusiveminions").hide();
	$(".team-summary-exclusiveminions").html("");
  } else {
    var htmlExclusiveMinions = "";
	for(var iExcl = 0; iExcl < exclusiveMinions.length; iExcl++)
	{
	  if (iExcl > 0)
	    htmlExclusiveMinions += '<br />';
	  htmlExclusiveMinions += exclusiveMinions[iExcl];
	}
	$(".team-summary-exclusiveminions").show();
	$(".team-summary-exclusiveminions").html(htmlExclusiveMinions);
  }
}

/************************/
/*** Helper Functions ***/
/************************/
function isInTable(tableData, searchedData)
{
  for(var i=0; i<tableData.length; i++)
  {
    if (tableData[i] == searchedData)
      return true;
  }
  return false;
}

function get(name)
{
  if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
    return decodeURIComponent(name[1]);
}

function pad (str, max) {
  str = str.toString();
  return str.length < max ? pad("0" + str, max) : str;
}

function imgError(image) {
    image.onerror = "";
    image.src = "img/default_thumbnail.jpg";
    return true;
}

/********************/
/*** Page loading ***/
/********************/
$(function() {     
  
  $('#enter-code-error').hide();
  $('#enter-code-warning').hide();
  
  fillAlignments();
  // Filters
  fill_roles();
  fill_origins();
  fill_factions();
   
  // The list of the Supremes
  fill_supremes();  
  
  update_summary();
  check_honorary_member();
  check_faction_cards();
  
   
  // Events on the Affiliation
  changeAffiliation();
  $('#selTeamAffiliation').change(confirmAffiliationChange);
   
  // Events on the filters
  $('#selRoles').on('change', function (e) { filter_supremes(); });
  $('#selOrigins').on('change', function (e) { filter_supremes(); });
  $('#selFactions').on('change', function (e) { filter_supremes(); });
  $('#selLevels').on('change', function (e) { filter_supremes(); });
  $('#selAPgranted').on('change', function (e) { filter_supremes(); });
  $('#selMinionsGranted').on('change', function (e) { filter_supremes(); });
  $('#txtFilterName').on('input', function (e) { filter_supremes(); });
  $('#honorary-member').click(function() { change_honorary_member(); });  
  
  $('#btn-validate-code').click(function() { enter_unique_code($('#lbl-enter-team-code').val()); });
});

</script>
</html>

