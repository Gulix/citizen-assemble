<html>
  <head>
    <script src="js/mustache.js"></script>
  
    <title>Citizen Assemble ! Pulp City Team Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen" />
    <link rel="stylesheet" href="css/style.css" />
  </head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2">
        <form>
          <div class="form-group">
            <label for="selTeamAffiliation">Team Alignment / Faction</label>
            <select class="form-control" id="selTeamAffiliation"></select>
          </div>
        </form>
      </div>
      <div class="col-md-9 col-md-offset-1">
        <h1>Citizen Assemble !</h1>
        <h2>A team builder for <b>Pulp City</b></h2>
      </div>      
    </div>
    
    <!-- Filters -->
    <div class="row">
      
      <!-- Team Summary -->
      <div class='col-md-2'>
        <p>Team Level : <strong id='team-summary-level'></strong></p>
        <p># of Supremes : <strong id='team-summary-number'></strong></p>
        <p>AP+ : <strong id='team-summary-apgranted'></strong></p>
        <p>Minions+ : <strong id='team-summary-minionsgranted'></strong></p>
      </div>
      
      <div class='col-md-10'>
        <!-- Factions -->
        <div class='col-md-2'>
          <label for="selFactions">Faction</label>
          <select id="selFactions" class="form-control" ></select>
        </div>
        <!-- Origins -->
        <div class='col-md-2'>
          <label for="selOrigins">Origin</label>
          <select id="selOrigins" class="form-control" ></select>
        </div>
        <!-- Roles -->
        <div class='col-md-2'>
          <label for="selRoles">Role</label>
          <select id="selRoles" class="form-control" ></select>
        </div>
        <!-- Levels -->
        <div class='col-md-2'>
          <label for="selLevels">Level</label>
          <select id="selLevels" class="form-control" >
            <option value='0'>Any</option>
            <option value='1'>Level 1</option>
            <option value='2'>Level 2</option>
            <option value='3'>Level 3</option>
            <option value='12'>Level 1 or 2</option>
            <option value='23'>Level 2 or 3</option>
          </select>
        </div>
        <!-- AP+ -->
        <div class='col-md-2'>
          <label for="selAPgranted">AP+</label>
          <select id="selAPgranted" class="form-control" >
            <option value='+0'>Any</option>
            <option value='+1'>1 or more</option>
            <option value='+2'>2 or more</option>
            <option value='+3'>3 or more</option>
            <option value='+4'>4 or more</option>
            <option value='=0'>0</option>
            <option value='=1'>1</option>
            <option value='=2'>2</option>
            <option value='=3'>3</option>
            <option value='=4'>4</option>
            <option value='-1'>1 or less</option>
            <option value='-2'>2 or less</option>
            <option value='-3'>3 or less</option>
            <option value='-4'>4 or less</option>
          </select>
        </div>
        <!-- Minions+ -->
        <div class='col-md-2'>
          <label for="selMinionsGranted">Minions+</label>
          <select id="selMinionsGranted" class="form-control" >
            <option value='+0'>Any</option>
            <option value='+1'>1 or more</option>
            <option value='+2'>2 or more</option>
            <option value='=0'>0</option>
            <option value='=1'>1</option>
            <option value='=2'>2</option>
            <option value='-1'>1 or less</option>
            <option value='-2'>2 or less</option>            
          </select>
        </div>
        <!-- Text filter -->
        <div class='col-md-4'>
          <label for="txtFilterName">Supreme name</label>
          <input id='txtFilterName' type="text" class="form-control" placeholder="Search for..."></input>          
        </div>
      </div>
    </div>
    
    <div class="row">
      <!-- Selected items -->
      <div class="col-md-2 bg-info supremes-selected-list" id="list-selected">        
      </div>
      <!-- List of items -->
      <div class="col-md-10 supremes-list" id="list-supremes">
      </div>
    </div>
    
    <div id="list-modal-supremes">
    </div>
  </div>
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
</body>
<script>

window.supremes_list = [];
window.selected_supremes_list = [];

/********************/
/*** The Supremes ***/
/********************/
function fill_supremes()
{
  $.getJSON("json/supremes.json", function(json) {
    
    // Sort by Name
    json.sort(function(a, b)
    {
      if (a.name < b.name) return -1;
      if (b.name < a.name) return 1;
      return 0;
    });
    window.supremes_list = json;
    window.selected_supremes_list = [];
    
    // Fill some fields (key to value)
    for(var i = 0; i < window.supremes_list.length; i++)
    {
      window.supremes_list[i].role = get_role_value(window.supremes_list[i].role_key);
    }
    
    // View to render via Mustache
    var view = { "supremes": window.supremes_list };
    
    // The main list
    $.ajax(
    {
      url: "mustache/supremes.mst",
      success: function( mustacheTemplate ) 
        {
          var renderedHtml = Mustache.render(mustacheTemplate, view);
          $("#list-supremes").html(renderedHtml);
          filter_supremes();
          $(".btn-select-supreme").click(function() { select_supreme(getSupremeId("btn-select-supreme-", $(this).attr('id'))); });
        },
      dataType: "text"
    });
    
    // The Supremes rendered on a modal view
    $.ajax(
    {
      url: "mustache/supremes_modal.mst",
      success: function( mustacheTemplate ) 
        {
          var renderedHtml = Mustache.render(mustacheTemplate, view);
          $("#list-modal-supremes").html(renderedHtml);
          // Events on Buttons
          $(".btn-select-supreme-modal").click(function() { select_supreme(getSupremeId("btn-select-supreme-modal-", $(this).attr('id'))); });
          $(".btn-unselect-supreme-modal").click(function() { unselect_supreme(getSupremeId("btn-unselect-supreme-modal-", $(this).attr('id'))); });
          $(".btn-unselect-supreme-modal").hide();
        },
      dataType: "text"
    });
    
    // The "Selected Supremes" list
    $.ajax(
    {
      url: "mustache/supremes_selection.mst",
      success: function( mustacheTemplate ) 
        {
          // Render the Supremes with a Mustache template
          var renderedHtml = Mustache.render(mustacheTemplate, view);
          $("#list-selected").html(renderedHtml);
          // Hiding the elements
          $(".supreme-selection").each(function() { $( this ).hide(); });
          // Click on Buttons
          $(".btn-unselect-supreme").click(function() { unselect_supreme(getSupremeId("btn-unselect-supreme-", $(this).attr('id'))); });
        },
      dataType: "text"
    });
  });  
}

function get_json_supreme(id)
{
  for(var i=0; i<window.supremes_list.length; i++)
    if (window.supremes_list[i].id == id) return window.supremes_list[i];
    
  return null;
}

/*************************/
/*** Selected Supremes ***/
/*************************/
function select_supreme(id)
{
  $("#supreme-selection-" + id).show();
  // Buttons in the modal view
  $("#btn-select-supreme-modal-" + id).hide();
  $("#btn-unselect-supreme-modal-" + id).show();
  window.selected_supremes_list.push(get_json_supreme(id));
  filter_supremes();
  update_summary();
}

function unselect_supreme(id)
{
  $("#supreme-selection-" + id).hide();
  // Buttons in the modal view
  $("#btn-select-supreme-modal-" + id).show();
  $("#btn-unselect-supreme-modal-" + id).hide();
  for(var i=0; i<window.selected_supremes_list.length; i++)
  {
    if (window.selected_supremes_list[i].id == id)
    {
      window.selected_supremes_list.splice(i, 1);
      break;
    }
  }
  
  filter_supremes();
  update_summary();
}

function clear_selection()
{
  $('.supreme-selection').hide();
  window.selected_supremes_list.splice(0, window.selected_supremes_list.length);
  filter_supremes();
  update_summary();
}

/*****************/
/*** The Roles ***/
/*****************/
// Fill the "Roles" combo box
function fill_roles()
{
  $.getJSON("json/roles.json", function(json) {
    
    window.supremes_roles = json;
    for(var i = 0; i < window.supremes_roles.length; i++)
    {
       $('#selRoles').append('<option value="' + window.supremes_roles[i].role_key + '">' + window.supremes_roles[i].role_label + '</option>');
    }
  });  
}

function get_role_value(role_key)
{
  for(var i = 0; i < window.supremes_roles.length; i++)
  {
    if (role_key == window.supremes_roles[i].role_key)
      return window.supremes_roles[i].role_label;    
  }
  
  return "???";
}

/*******************/
/*** The Origins ***/
/*******************/
function fill_origins()
{
  $.getJSON("json/origins.json", function(json) {
    
    for(var i = 0; i < json.length; i++)
    {
       $('#selOrigins').append('<option value="' + json[i].origin_key + '">' + json[i].origin_label + '</option>');
    }
  });  
}

/********************/
/*** The Factions ***/
/********************/
function fill_factions()
{
  $.getJSON("json/factions.json", function(json) {
    // Sort factions by name
    json.sort(function(a, b)
    {
      if (a.faction_key < b.faction_key) return -1;
      if (b.faction_key < a.faction_key) return 1;
      return 0;
    });
    
    var ignoredFactions = [ "-0", "-1", "-2" ];
    $('#selTeamAffiliation').append('<optgroup label="Factions" id="optgTeamAffiliationFaction"></optgroup>');
    for(var i = 0; i < json.length; i++)
    {
      // Add the factions in the Affiliation combo box
      if (!isInTable(ignoredFactions, json[i].faction_key))
        $('#optgTeamAffiliationFaction').append('<option value="f_' + json[i].faction_key + '">' + json[i].faction_label + '</option>');
      // Add the factions in the Factions combo box
      $('#selFactions').append('<option value="' + json[i].faction_key + '">' + json[i].faction_label + '</option>');
    }
    
    $('#selFactions').val("-0");
  });
}

/******************/
/*** Alignments ***/
/******************/
function fillAlignments()
{
  $('#selTeamAffiliation').append('<optgroup label="Alignments">'
                                   + '<option value="a_heroes">Heroes</option>'
                                   + '<option value="a_villains">Villains</option>'
                                 + '</optgroup>');
}

/************************/
/*** Team Affiliation ***/
/************************/
function changeAffiliation()
{
  var affiliation = $('#selTeamAffiliation').val();
  if (affiliation === null) return;
  var isAlignment = (affiliation.indexOf('a_') === 0);
  var isFaction = (affiliation.indexOf('f_') === 0);
  
  if (isFaction)
  {
    // The faction filter is set and disabled to the selected Faction in the Affiliation
    var keyFaction = affiliation.substring(2);
    $('#selFactions').val(keyFaction);
    $('#selFactions').prop('disabled', 'disabled');
  }
  else if (isAlignment)
  {
    $('#selFactions').prop('disabled', false);
  }
  
  filter_supremes();
}

function getSupremeId(strStartId, strId)
{
  return strId.substring(strStartId.length);
}

function confirmAffiliationChange()
{
  var countSelectedSupremes = $('.supreme-selection:visible').length;
  if (countSelectedSupremes > 0)
  {
    if (!confirm('Are you sure you want to change your Team Affiliation ?\nYour team composition will be cleared.')) 
    {
      var current = $.data(this, 'current');
      if ((current === null) || (current === undefined))
        current = "a_heroes";
      $(this).val(current); // added parenthesis (edit)
      return false;
    }
  }
  
  $.data(this, 'current', $(this).val());
  clear_selection();
  changeAffiliation();
}

/**************/
/*** Filter ***/
/**************/
function filter_supremes()
{
   
  // Role filter
  var roleFilter = $('#selRoles').val();
  if (roleFilter === null)
    roleFilter = "0";
  // Origin filter
  var originFilter = $('#selOrigins').val();
  if (originFilter === null)
    originFilter = "0";
  // Faction filter
  var factionFilter = $('#selFactions').val();
  if (factionFilter === null)
    factionFilter = "-0"; 
  var isFactionSelected = !isInTable(["-0", "-1", "-2"], factionFilter);
  var isFactionWithout = (factionFilter == "-1");
  var isFactionWithoutWithFreelance = (factionFilter == "-2");
  // Levels
  var levelsAccepted = [ ];
  var levelFilter = $("#selLevels").val();
  if (levelFilter === null)
    levelFilter = "0";
  if ((levelFilter == "0") || levelFilter.indexOf("1") > -1)
    levelsAccepted.push(1);
  if ((levelFilter == "0") || levelFilter.indexOf("2") > -1)
    levelsAccepted.push(2);
  if ((levelFilter == "0") || levelFilter.indexOf("3") > -1)
    levelsAccepted.push(3);
  // AP+
  var apFilter = $("#selAPgranted").val();
  if (apFilter === null)
    apFilter = "+0";
  var apValue = Number(apFilter.substring(1));
  if (isNaN(apValue)) apValue = 0;
  var apgrantedAccepted = [ ];
  if (apFilter.indexOf("+") == 0)
    for(var i = apValue; i <= 6; i++) { apgrantedAccepted.push(i); }
  else if (apFilter.indexOf("-") == 0)
    for(var i = apValue; i >= 0; i--) { apgrantedAccepted.push(i); }
  else if (apFilter.indexOf("=") == 0)
    apgrantedAccepted.push(apValue);    
  // Minions+
  var minionsFilter = $("#selMinionsGranted").val();
  if (minionsFilter === null)
    minionsFilter = "+0";
  var minionsValue = Number(minionsFilter.substring(1));
  if (isNaN(minionsValue)) minionsValue = 0;
  var minionsGrantedAccepted = [ ];
  if (minionsFilter.indexOf("+") == 0)
    for(var i = minionsValue; i <= 3; i++) { minionsGrantedAccepted.push(i); }
  else if (minionsFilter.indexOf("-") == 0)
    for(var i = minionsValue; i >= 0; i--) { minionsGrantedAccepted.push(i); }
  else if (minionsFilter.indexOf("=") == 0)
    minionsGrantedAccepted.push(minionsValue);    
  // Filter on name
  var filterName = $('#txtFilterName').val();
  if (filterName === null)
    filterName = '';
  filterName = filterName.trim().toUpperCase();
   
  // Heroes / Villains
  var alignment = $('#selTeamAffiliation').val();
  var isHeroesOnly = (alignment == 'a_heroes');
  var isVillainsOnly = (alignment == 'a_villains');
    
  var excludeLeader = false; // Only one Leader
  var excludePowerhouse = false; // Only one Powerhouse
  var excludedSupremesId = []; // List of excluded Supremes
  for (var iSel=0; iSel < window.selected_supremes_list.length; iSel++)
  {
    if (window.selected_supremes_list[iSel].role_key == "leader")
      excludeLeader = true;
    if (window.selected_supremes_list[iSel].role_key == "powerhouse")
      excludePowerhouse = true;
      
    if (window.selected_supremes_list[iSel].excluded_supremes)
    {
      for (var iExcl = 0; iExcl < window.selected_supremes_list[iSel].excluded_supremes.length; iExcl++)
        excludedSupremesId.push(window.selected_supremes_list[iSel].excluded_supremes[iExcl]);
    }
  }
  
  
  
   
  for(var i=0; i < window.supremes_list.length; i++)
  {
    var isSelected = $('#supreme-selection-' + window.supremes_list[i].id).is(':visible');
  
    if (((roleFilter != "0") && (window.supremes_list[i].role_key != roleFilter)) // Role
     || ((originFilter != "0") && (window.supremes_list[i].origin != originFilter)) // Origin
     // Factions
     || (isFactionSelected && !isInTable(window.supremes_list[i].factions, factionFilter))
     || (isFactionWithout && !(window.supremes_list[i].factions.length == 0))
     || (isFactionWithoutWithFreelance && !(window.supremes_list[i].factions.length == 0) && !window.supremes_list[i].is_freelance)
     // Level
     || ($.inArray(window.supremes_list[i].level, levelsAccepted) == -1)
     // AP+
     || ((window.supremes_list[i].role_key == "powerhouse") && (apgrantedAccepted.indexOf(0) < 0))
     || ((window.supremes_list[i].role_key != "powerhouse") && (apgrantedAccepted.indexOf(window.supremes_list[i].ap_granted) < 0))
     // Minions+
     || (minionsGrantedAccepted.indexOf(window.supremes_list[i].minions_granted) < 0)
     // Filter on name
     || ((filterName != '') && (window.supremes_list[i].name.toUpperCase().indexOf(filterName) < 0))
     // Hero
     || (isHeroesOnly && !window.supremes_list[i].is_hero) 
     // Villain
     || (isVillainsOnly && !window.supremes_list[i].is_villain) 
     || isSelected
     // Only one Leader / Powerhouse
     || (excludeLeader && (window.supremes_list[i].role_key == "leader"))
     || (excludePowerhouse && (window.supremes_list[i].role_key == "powerhouse"))
     // Excluded supremes
     || (isInTable(excludedSupremesId, window.supremes_list[i].id))
    )
    {
      $('#supreme-list-' + window.supremes_list[i].id).hide();
    }
    else
    {
      $('#supreme-list-' + window.supremes_list[i].id).show();
    }
  }
}

/***************/
/*** Summary ***/
/***************/
function update_summary()
{
  var teamLevel = 0;
  var teamNumber = 0;
  var teamAP = 0;
  var teamMinions = 0;
  for(var i=0; i<window.supremes_list.length; i++)
  {
    if ($("#supreme-selection-" + window.supremes_list[i].id).is(':visible') == true)
    {
      teamLevel += window.supremes_list[i].level;
      teamNumber += 1;
      if (window.supremes_list[i].role_key != "powerhouse")
        teamAP += window.supremes_list[i].ap_granted;
      teamMinions += window.supremes_list[i].minions_granted;
    }
  }
    
  $("#team-summary-level").html(teamLevel);
  $("#team-summary-number").html(teamNumber);
  $("#team-summary-apgranted").html(teamAP);
  $("#team-summary-minionsgranted").html(teamMinions);  
}

/************************/
/*** Helper Functions ***/
/************************/
function isInTable(tableData, searchedData)
{
  for(var i=0; i<tableData.length; i++)
  {
    if (tableData[i] == searchedData)
      return true;
  }
  return false;
}

// Page loading
$(function() {     
  
  fillAlignments();
  // Filters
  fill_roles();
  fill_origins();
  fill_factions();
   
  // The list of the Supremes
  fill_supremes();  
  
  update_summary();
   
  // Events on the Affiliation
  changeAffiliation();
  $('#selTeamAffiliation').change(confirmAffiliationChange);
   
  // Events on the filters
  $('#selRoles').on('change', function (e) { filter_supremes(); });
  $('#selOrigins').on('change', function (e) { filter_supremes(); });
  $('#selFactions').on('change', function (e) { filter_supremes(); });
  $('#selLevels').on('change', function (e) { filter_supremes(); });
  $('#selAPgranted').on('change', function (e) { filter_supremes(); });
  $('#selMinionsGranted').on('change', function (e) { filter_supremes(); });
  $('#txtFilterName').on('input', function (e) { filter_supremes(); });
});

</script>
</html>

