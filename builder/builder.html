<html>
  <head>
    <script src="js/mustache.js"></script>
  
    <title>Citizen Assemble ! Pulp City Team Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen" />
    <link rel="stylesheet" href="css/style.css" />
  </head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2">
        <form>
          <div class="form-group">
            <label for="selTeamAffiliation">Team Alignment / Faction</label>
            <select class="form-control" id="selTeamAffiliation"></select>
          </div>
        </form>
      </div>
      <div class="col-md-9 col-md-offset-1">
        <h1>Citizen Assemble !</h1>
        <h2>A team builder for <b>Pulp City</b></h2>
      </div>      
    </div>
    
    <!-- Filters -->
    <div class="row">
      <!-- Factions -->
      <div class='col-md-offset-2 bg-danger'>
        <div class='col-md-2'>
          <label for="selFactions">Faction</label>
          <select id="selFactions" class="form-control" ></select>
        </div>
      </div>      
      <!-- Role -->
      <div class='col-md-offset-2 bg-danger'>
        <div class='col-md-2'>
          <label for="selRoles">Role</label>
          <select id="selRoles" class="form-control" ></select>
        </div>
      </div>
    </div>
    
    <div class="row">
      <!-- Selected items -->
      <div class="col-md-2 bg-info" id="list-selected">
        <p>Test</p>
      </div>
      <!-- List of items -->
      <div class="col-md-10 bg-danger" id="list-supremes">
      </div>
    </div>
    
    <div id="list-modal-supremes">
    </div>
  </div>
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
</body>
<script>


function fill_supremes()
{
  $.getJSON("json/supremes.json", function(json) {
    
    // Render the Supremes with a Mustache template
    var view = { "supremes": json };
    
    $.ajax(
    {
      url: "mustache/supremes.mst",
      success: function( mustacheTemplate ) 
        {
          var renderedHtml = Mustache.render(mustacheTemplate, view);
          $("#list-supremes").html(renderedHtml);
        },
      dataType: "text"
    });
  });  
}

function fill_supremes_modal()
{
  $.getJSON("json/supremes.json", function(json) {
      
    // Render the Supremes with a Mustache template
    var view = { "supremes": json };
    $.ajax(
    {
      url: "mustache/supremes_modal.mst",
      success: function( mustacheTemplate ) 
        {
          var renderedHtml = Mustache.render(mustacheTemplate, view);
          $("#list-modal-supremes").html(renderedHtml);
          // Click on Select Buttons
          $(".btn-select-supreme").click(function() {
            var supremeId = getSupremeId("btn-select-supreme-", $(this).attr('id'));
            $("#supreme-selection-" + supremeId).show();
          });
        },
      dataType: "text"
    });
  });  
}

// Fill the selected list with all the Supremes, then hide them
function fill_supremes_selection()
{
  $.getJSON("json/supremes.json", function(json) {
      
    var view = { "supremes": json };
    $.ajax(
    {
      url: "mustache/supremes_selection.mst",
      success: function( mustacheTemplate ) 
        {
          // Render the Supremes with a Mustache template
          var renderedHtml = Mustache.render(mustacheTemplate, view);
          $("#list-selected").html(renderedHtml);
          // Hiding the elements
          $(".supreme-selection").each(function() { $( this ).hide(); });
          // Click on Buttons
          $(".btn-unselect-supreme").click(function() {
            var supremeId = getSupremeId("btn-unselect-supreme-", $(this).attr('id'));
            $("#supreme-selection-" + supremeId).hide();
          });
        },
      dataType: "text"
    });
  });
}

function select_supreme(id)
{
  $("#supreme-selection-" + id).show();
}

// Fill the "Roles" combo box
function fill_roles()
{
  $.getJSON("json/roles.json", function(json) {
    
    $.each(json, function(i) 
    {
       $('#selRoles').append('<option value="' + json[i].role_key + '">' + json[i].role_label + '</option>');
    });    
  });  
}

/********************/
/*** The Factions ***/
/********************/
function fill_factions()
{
  $.getJSON("json/factions.json", function(json) {
    // Sort factions by name
    json.sort(function(a, b)
    {
      if (a.faction_key < b.faction_key) return -1;
      if (b.faction_key < a.faction_key) return 1;
      return 0;
    });
    
    var ignoredFactions = ["0", "-1", "-2"];
    
    $('#selTeamAffiliation').append('<optgroup label="Factions" id="optgTeamAffiliationFaction"></optgroup>');
    for(i = 0; i < json.length; i++)
    {
      // Add the factions in the Affiliation combo box
      if ((json[i].faction_key != "0") && (json[i].faction_key != "-1") && (json[i].faction_key != "-2"))
        $('#optgTeamAffiliationFaction').append('<option value="f_' + json[i].faction_key + '">' + json[i].faction_label + '</option>');
      // Add the factions in the Factions combo box
      $('#selFactions').append('<option value="' + json[i].faction_key + '">' + json[i].faction_label + '</option>');
    }
  });  
}

/******************/
/*** Alignments ***/
/******************/
function fillAlignments()
{
  $('#selTeamAffiliation').append('<optgroup label="Alignments">'
                                   + '<option value="a_heroes">Heroes</option>'
                                   + '<option value="a_villains">Villains</option>'
                                 + '</optgroup>');
}

/************************/
/*** Team Affiliation ***/
/************************/
function changeAffiliation()
{
  var affiliation = $('#selTeamAffiliation').val();
  if (affiliation === null) return;
  var isAlignment = (affiliation.indexOf('a_') === 0);
  var isFaction = (affiliation.indexOf('f_') === 0);
  
  if (isFaction)
  {
    // The faction filter is set and disabled to the selected Faction in the Affiliation
    var keyFaction = affiliation.substring(2);
    $('#selFactions').val(keyFaction);
    $('#selFactions').prop('disabled', 'disabled');
  }
  else if (isAlignment)
  {
    $('#selFactions').prop('disabled', false);
  }
  
  filter_supremes();
}

function getSupremeId(strStartId, strId)
{
  return strId.substring(strStartId.length);
}

/**************/
/*** Filter ***/
/**************/
function filter_supremes()
{
  $.getJSON("json/supremes.json", function(jsonSupremes) {
  
    // Role filter
    var roleFilter = $('#selRoles').val();
    if (roleFilter === null)
      roleFilter = "0";
    // Faction filter
    var factionFilter = $('#selFactions').val();
    if (factionFilter === null)
      factionFilter = "0"; 
    var isFactionSelected = (factionFilter != "0") && (factionFilter != "-1") && (factionFilter != "-2");
    var isFactionWithout = (factionFilter == "-1");
    var isFactionWithoutWithFreelance = (factionFilter == "-2");
    
    // Heroes / Villains
    var alignment = $('#selTeamAffiliation').val();
    var isHeroesOnly = (alignment == 'a_heroes');
    var isVillainsOnly = (alignment == 'a_villains');
     
    $.each(jsonSupremes, function(i)
    {
      if (((roleFilter != "0") && (jsonSupremes[i].role_key != roleFilter)) // Role
       // Factions
       || (isFactionSelected && !isInTable(jsonSupremes[i].factions, factionFilter))
       || (isFactionWithout && !(jsonSupremes[i].factions.length == 0))
       || (isFactionWithoutWithFreelance && !(jsonSupremes[i].factions.length == 0) && !jsonSupremes[i].is_freelance)
       || (isHeroesOnly && !jsonSupremes[i].is_hero) // Hero
       || (isVillainsOnly && !jsonSupremes[i].is_villain)) // Villain
        $('#supreme-list-' + jsonSupremes[i].id).hide();
      else
        $('#supreme-list-' + jsonSupremes[i].id).show();
    });  
  });
}

/************************/
/*** Helper Functions ***/
/************************/
function isInTable(tableData, searchedData)
{
  for(i=0; i<tableData.length; i++)
  {
    if (tableData[i] == searchedData)
      return true;
  }
  return false;
}

// Page loading
$(function() {   
  
  fillAlignments();
  // Filters
  fill_roles();
  fill_factions();
   
  // The list of the Supremes
  fill_supremes();
  fill_supremes_modal();
  fill_supremes_selection();
   
  // Events on the Affiliation
  changeAffiliation();
  $('#selTeamAffiliation').on('change', function (e) { changeAffiliation(); });  
   
  // Events on the filters
  $('#selRoles').on('change', function (e) { filter_supremes(); });
  $('#selFactions').on('change', function (e) { filter_supremes(); });
    
  // Filter the Supremes
  filter_supremes();
});

</script>
</html>

